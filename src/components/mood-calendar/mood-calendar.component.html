<div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
  <div class="flex justify-between items-center mb-4">
    <div class="flex items-center gap-2">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 min-w-[140px] text-center sm:text-left">
        {{ currentDate() | date:'LLLL yyyy' }}
      </h3>
      <button (click)="changeMonth(-1)" aria-label="Previous month" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <svg class="h-5 w-5 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
        </svg>
      </button>
      <button (click)="changeMonth(1)" aria-label="Next month" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <svg class="h-5 w-5 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>

    @if (!isCurrentMonth()) {
      <button (click)="goToToday()" class="px-3 py-1.5 text-xs font-semibold text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
        Today
      </button>
    }
  </div>
  <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 dark:text-gray-400 mb-2">
      <div>Sun</div>
      <div>Mon</div>
      <div>Tue</div>
      <div>Wed</div>
      <div>Thu</div>
      <div>Fri</div>
      <div>Sat</div>
  </div>
  <div #calendarContainer class="w-full"></div>
  <div class="flex justify-center flex-wrap gap-x-4 gap-y-2 mt-4 text-xs">
    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-400"></span><span class="text-gray-600 dark:text-gray-400">Happy</span></div>
    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-400"></span><span class="text-gray-600 dark:text-gray-400">Calm</span></div>
    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-400"></span><span class="text-gray-600 dark:text-gray-400">Sad</span></div>
    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-500"></span><span class="text-gray-600 dark:text-gray-400">Energetic</span></div>
    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-400"></span><span class="text-gray-600 dark:text-gray-400">Neutral</span></div>
  </div>
</div>

@if (selectedDayEntries(); as entries) {
  <!-- Backdrop -->
  <div class="fixed inset-0 z-20" (click)="closePopover()"></div>

  <!-- Popover -->
  <div 
    class="fixed z-30 bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-3 border dark:border-gray-700 w-60 text-sm"
    [style.top]="popoverPosition()?.top + 'px'"
    [style.left]="popoverPosition()?.left + 'px'"
    (click)="$event.stopPropagation()">
    <div class="flex justify-between items-center mb-2 pb-2 border-b dark:border-gray-600">
      <h4 class="font-semibold text-gray-800 dark:text-gray-100">
        Entries for {{ entries[0].date | date:'mediumDate' }}
      </h4>
      <button (click)="closePopover()" class="p-1 -mr-1 -mt-1 rounded-full text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <span class="sr-only">Close</span>
      </button>
    </div>
    <ul class="space-y-1.5 max-h-48 overflow-y-auto pr-1">
      @for(entry of entries; track entry.id) {
        <li class="text-gray-700 dark:text-gray-300 font-medium flex justify-between items-center gap-2.5">
          <div class="flex items-start gap-2.5 truncate">
              <span class="text-base mt-px">{{ getMoodEmoji(entry.mood) }}</span>
              <span class="truncate flex-1">{{ entry.title }}</span>
          </div>
          @if (entry.time) {
            <span class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0">{{ (entry.date + 'T' + entry.time) | date:'shortTime' }}</span>
          }
        </li>
      }
    </ul>
  </div>
}
